#include <Keypad.h>
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
{'1','2','3','A'},
{'4','5','6','B'},
{'7','8','9','C'},
{'','0','#','D'}
};
byte rowPins[ROWS] = {11,10,9,1};
byte colPins[COLS] = {0,A0,A1,A2};
Keypad customKeypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);
char tecla_Presionada;
int numero_De_Teclas_Presionadas;
int numero_Intentos_Para_Desactivar_Alarma;
int numero_Intentos_Fallados;
char contrasenia = "1234";
int x = 0; // comienza siendo igual a cero
//FIN KEYPAD 4X4----------------------------------------------------------------------------------------

//INICIO LCD 16X2---------------------------------------------------------------------------------------
#include <LiquidCrystal.h>
LiquidCrystal lcd(18, 17, 5, 4, 3, 2);
//FIN LCD 16X2----------------------------------------------------------------------------------------

//INICIO SENSOR PIR---------------------------------------------------------------------------------------
int pinSensor_PIR = 12;
int estado_Sensor_PIR;
boolean sensores_Activ = false;
//FIN SENSOR PIR----------------------------------------------------------------------------------------

//INICIO BUZZER---------------------------------------------------------------------------------------
int pinBuzzer = 7;
int frec = 1000;
boolean alarma_Activ = false; // la alarma comienza desactivada
//FIN BUZZER----------------------------------------------------------------------------------------

boolean bandera = false;

//INICIO SETUP---------------------------------------------------------------------------------------
void setup(){

lcd.begin(16,2);

pinMode(pinSensor_PIR, INPUT);

pinMode(pinBuzzer, OUTPUT);

}
//FIN SETUP---------------------------------------------------------------------------------------

//INICIO FUNCIONES---------------------------------------------------------------------------------------
void mostrar_Mensaje_SENSORES_ACTIVADOS_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" SENSORES ");
lcd.setCursor(0,1);
lcd.print(" ACTIVADOS ");

}

void mostrar_Mensaje_SENSORES_DESACTIVADOS_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" SENSORES ");
lcd.setCursor(0,1);
lcd.print(" DESACTIVADOS ");

}

void mostrar_Mensaje_ALARMA_ACTIVADA_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" ALARMA ");
lcd.setCursor(0,1);
lcd.print(" ACTIVADA ");

}

void mostrar_Mensaje_ALARMA_DESACTIVADA_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" ALARMA ");
lcd.setCursor(0,1);
lcd.print(" DESACTIVADA ");

}

void mostrar_Mensaje_INGRESE_CONTRASENIA_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" INGRESE ");
lcd.setCursor(0,1);
lcd.print(" CONTRASENIA ");

}

void mostrar_Mensaje_CONTRASENIA_INCORRECTA_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" CONTRASENIA ");
lcd.setCursor(0,1);
lcd.print(" INCORRECTA ");

}

void mostrar_Mensaje_LE_QUEDAN_X_INTENTOS_En_LCD(){

lcd.setCursor(0,0);
lcd.print("TE QUEDAN ");
lcd.setCursor(0,1);
lcd.print(numero_Intentos_Para_Desactivar_Alarma - 1);
lcd.print(" INTENTOS ");

}

void mostrar_Mensaje_SISTEMA_DE_ALARMA_PARA_CASA_En_LCD(){

lcd.setCursor(0,0);
lcd.print(" SISTEMA DE ");
lcd.setCursor(0,1);
lcd.print("ALARMA PARA CASA");

}

void mostrar_Mensaje_NO_PUEDE_VOLVER_A_INGRESAR_CONTRASENIA_En_LCD(){

lcd.setCursor(0,0);
lcd.print("NO PUEDE VOL. A ");
lcd.setCursor(0,1);
lcd.print("ING. CONTRASENIA");

}

void sonar_Buzzer(){

tone(pinBuzzer, frec);

}

void dejar_De_Sonar_Buzzer(){

noTone(pinBuzzer);

}

void activar_Sensores(){

if(sensores_Activ == false){ // comienza sienso false, o sea, comienza con los sensores desactivados

estado_Sensor_PIR = LOW; // sensores desactivados

mostrar_Mensaje_SENSORES_DESACTIVADOS_En_LCD();  


x = 0; // para que desde cero comienze a llenarse de números y poder crear la contraseña con ellos, con el objetivo de desactivar la alarma
  
numero_De_Teclas_Presionadas = 0; // para que desde cero comienze a contar el número de teclas presionadas
  
numero_Intentos_Para_Desactivar_Alarma = 3; // te da tres intentos para desactivar la alarma
  
numero_Intentos_Fallados = 0; // para llenar los intentos fallados desde cero   

//presiono A si deseo activar los sensores
if(tecla_Presionada == 'A'){ // si presiono A, activo los sensores
  
  sensores_Activ = true; // ahora es true, o sea, ahora los sensores están activados
}
}
}

void activar_Alarma_Por_Sensores(){

  //INICIO ACTIVAR ALARMA POR SENSOR PIR************************************************
  if(estado_Sensor_PIR == HIGH){
  
    sonar_Buzzer(); // se activa la alarma
 
    lcd.clear();
    
    mostrar_Mensaje_ALARMA_ACTIVADA_En_LCD();
 
    // luego te da los siguientes valores
  
    x = 0; // para que desde cero comienze a llenarse de números y poder crear la contraseña con ellos, con el objetivo de desactivar la alarma
  
    numero_De_Teclas_Presionadas = 0; // para que desde cero comienze a contar el número de teclas presionadas
  
    numero_Intentos_Para_Desactivar_Alarma = 3; // te da tres intentos para desactivar la alarma
  
    numero_Intentos_Fallados = 0; // para llenar los intentos fallados desde cero     
  }
  //FIN ACTIVAR ALARMA POR SENSOR PIR****************************************************
}

void ingresar_Contrasenia(){

    //INICIO DESACTIVAR ALARMA POR CONTRASEÑA**********************************************
    if(x==4){ // coinciden los 4 números // si se ingresa la contraseña correcta
       
      dejar_De_Sonar_Buzzer(); // desactivar alarma
      
      mostrar_Mensaje_ALARMA_DESACTIVADA_En_LCD();
  
      //luego de ta los siguientes valores
  
      x = 0; // como se llenó después de haber ingresado la contraseña, regresa a cero para que se pueda volver a llenar de números y así poder crear la contraseña nuevamente por si la alarma se vuelve a activar o sigue activada

      numero_De_Teclas_Presionadas = 0; // como se llenó después de haber ingresado la contraseña, regresa a cero para que cuente el número de teclas presionadas nuevamente por si la alarma se vuelve a activar o sigue activada
  
      estado_Sensor_PIR == LOW; // se apaga el sensor PIR
  
      alarma_Activ = false;
      
      bandera = false;
      
      sensores_Activ = false;
  
      // ahora que la alarma está desactivada, los if de abajo ya no son de utilidad
    }
    //FIN DESACTIVAR ALARMA POR CONTRASEÑA*************************************************

    
    
    //INICIO ERROR AL INGRESAR CONTRASEÑA**************************************************
    if(x != 4 && numero_De_Teclas_Presionadas == 4 && numero_De_Teclas_Presionadas != 0){ // si se ingresa mal la contraseña
    
      lcd.clear();

      mostrar_Mensaje_CONTRASENIA_INCORRECTA_En_LCD();

      delay(1000);

      lcd.clear();

      mostrar_Mensaje_LE_QUEDAN_X_INTENTOS_En_LCD();

      delay(1000);

      lcd.clear();

      mostrar_Mensaje_INGRESE_CONTRASENIA_En_LCD();

      numero_Intentos_Fallados++; // el número de intentos fallados aumenta de uno en uno cada vez que se ingresa mal la contraseña
  
      numero_Intentos_Para_Desactivar_Alarma--; // los tres intenteos se restan de uno en uno cada vez que se ingresa mal la contraseña

      x = 0; // como se llenó después de haber ingresado la contraseña, regresa a cero para que se pueda volver a llenar de números y así poder crear la contraseña nuevamente por si la alarma se vuelve a activar o sigue activada
  
      numero_De_Teclas_Presionadas = 0; // // como se llenó después de haber ingresado la contraseña, regresa a cero para que cuente el número de teclas presionadas nuevamente por si la alarma sigue activada o se vuelve a activar    

      alarma_Activ = true; // sigue siendo true
  
      // ahora se tiene que nuevamente ingresar la contraseña y ver que if va a usar, DESACTIVAR ALARMA POR CONTRASEÑA o ERROR AL INGRESAR CONTRASEÑA
    }
    //FIN ERROR AL INGRESAR CONTRASEÑA*****************************************************



    //INICIO YA NO PUEDE VOLVER A INGRESAR CONTRASEÑA**************************************
    if(numero_Intentos_Fallados == 3){ // si el número de intentos fallados es igual a tres    

      sonar_Buzzer(); // la alarma sigue activada

      mostrar_Mensaje_NO_PUEDE_VOLVER_A_INGRESAR_CONTRASENIA_En_LCD();
  
      x = 5; // no puede ser cero ahora, pues nuevamente se podría ingresar la contraseña

      numero_De_Teclas_Presionadas = 5; // no puede ser cero ahora, pues contaría nuevamente el números de teclas presionadas
  
      // ya no se puede hacer nada
    }
    //FIN YA NO PUEDE VOLVER A INGRESAR CONTRASEÑA**************************************** 
}

//FIN FUNCIONES----------------------------------------------------------------------------------------

//INICIO LOOP-----------------
void loop(){

estado_Sensor_PIR = digitalRead(12);

//esto hace que el x y el numero_De_Teclas_Prionadas se llene
tecla_Presionada = customKeypad.getKey();

if(bandera==false){

activar_Sensores(); // aquí presiono A

}

//////////////////////////////////////////////////////////////////////////////////////////////
if(sensores_Activ == true){ // ahora los sensores están activados por haber presionado A

if(bandera==false){

mostrar_Mensaje_SENSORES_ACTIVADOS_En_LCD();



if(alarma_Activ == false){ // comienza con la alarma desactivada
    
  activar_Alarma_Por_Sensores();    
  
  
}

}



if(tecla_Presionada == 'B'){ // si presiono B, tengo que ingresar contraseña para desactivar sensores y/o apagar la alarma
  
  lcd.clear();

  alarma_Activ = true;
  
  bandera = true;
  
    
  
}
     
  



if(bandera==true){

mostrar_Mensaje_INGRESE_CONTRASENIA_En_LCD(); // ingresar contraseña para desactivar sensores y/o alarma

  
 if(tecla_Presionada){                                                      
                                                                         
      numero_De_Teclas_Presionadas++; // comienza siendo igual a cero        
    }                                                                         
    
    if(tecla_Presionada == contrasenia[x]){                                  
                                                                         
      x++; // comienza siendo igual a cero                                   
    }  
  
  
  
  
//INICIO INGRESAR CONTRASEÑA después de haber presionado B
if(alarma_Activ == true){  
  
  
      
  
  
    
  ingresar_Contrasenia();
  
}


}
